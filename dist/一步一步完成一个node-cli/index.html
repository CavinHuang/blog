<!DOCTYPE html><html lang=zh><head><meta charset=UTF-8><meta name=baidu-site-verification content=rqskM4bdtP><meta name=viewport content="device-width, initial-scale=1, maximum-scale=1,user-scalable=no"><title>一步一步完成一个node-cli-CavinHuang-不懂写故事的猫-http://blog.zukmb.cn</title><meta name=keywords content=前端学习,php学习,个人博客,HTML,CSS,JS><meta name=description content=cavinHuang个人博客，这里记录学习和生活的点滴！><meta name=google-site-verification content=zOYxWUgmeogC0qY76WLP0eWl8r9E8jk_qU927Ij7tbs><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a4c3745fa28006f"></script><link rel=stylesheet href=/css/yoyo.css><link rel=icon href=/img/favicon.png><link rel=stylesheet href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.3"><script src=//cdn.bootcss.com/jquery/3.2.1/jquery.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdn.bootcss.com/velocity/1.5.0/velocity.min.js></script></head><body></body></html><div class=app><div class=left-container><canvas id=cas></canvas><div class="left-layout-container pc"><div class=user-info><a href="/"><img src="https://avatars1.githubusercontent.com/u/24950299?s=460&amp;v=4"></a><div class=login-name>CavinHuang</div><div class=slog>来不及总结自己,愿天大地大,我独一无二!</div></div><ul class=other-site><li><img src=http://www.17sucai.com/preview/177065/2017-09-28/Mon9/static/img/github.png></li><li><img src=http://www.17sucai.com/preview/177065/2017-09-28/Mon9/static/img/weibo.png></li></ul><ul class=left-menu><li><a href=/archives>文章</a></li><li><a href=/categories>分类</a></li><li><a href=/tags>标签</a></li><li><a href=/about>关于</a></li></ul><div class=qq-group><span>读万卷书</span><span>行万里路</span></div><div class=copyright>@ 2017 - 2017 CavinHuang</div></div></div><div class="blog-container main-container" id=content-outer><div class=blog-list-container id=content-inner><article class=article-container id=post><div class=article-header><h1 class=article-title>一步一步完成一个node-cli</h1><div class=article-subtitle><div class="publish-time fl">发布时间:<span>2018/2/3 11:32:49</span></div><div class=categories>分类:<a href="/categories/nodejs学习笔录/"><span>nodejs学习笔录</span></a>/<a href="/categories/nodejs学习笔录/web前端开发/"><span>web前端开发</span></a></div></div></div><div class=article-content><p>node-cli 即用nodejs与shell交互，完成指定工作的工具。他们通常是长这样的：<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div></pre></td><td class=code><pre><div class=line>sass xx.scss:xx.css</div><div class=line>webpack ....</div></pre></td></tr></table></figure></p><a id=more></a><p>等等，我们实现的这个工具是为了拉取<a href=https://github.com/CavinHuang/webpack-multi-skeleton target=_blank rel=external>CavinHuang/webpack-multi-skeleton webpack 多页面骨架</a>用于本地快速构建项目的脚手架工具，设想通过以下命令来实现：<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div></pre></td><td class=code><pre><div class=line>webpack-template i  <span class=comment># install git端所有的模板列表供选择，选择其中之一后进行本地缓存</span></div><div class=line>webpack-template init <span class=comment># 通过一些选项，初始化整个项目</span></div></pre></td></tr></table></figure></p><p>整个设想大概就是这些，下面就从最简单的开始，来一步一步实现。</p><h1 id=实现第一个自己的node命令><a href=#实现第一个自己的node命令 class=headerlink title=实现第一个自己的node命令></a>实现第一个自己的node命令</h1><p>我们直接用npm init初始化一个项目出来<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>npm init node-cli-demo</div></pre></td></tr></table></figure></p><p>一路yes即可，进入项目，在package.json中添加如下代码<br><figure class=highlight><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div></pre></td><td class=code><pre><div class=line>"bin": &#123;</div><div class=line>  "hi": "./bin/hi.js"</div><div class=line>&#125;,</div></pre></td></tr></table></figure></p><p>创建bin目录和hi.js,在hi.js中写下如下代码<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div></pre></td><td class=code><pre><div class=line><span class=meta>#!/usr/bin/env node</span></div><div class=line><span class=built_in>console</span>.log(<span class=string>'Hi Welcome node cli'</span>)</div></pre></td></tr></table></figure></p><p>用命令行进入当前项目目录，输入<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>hi</div></pre></td></tr></table></figure></p><p>如果提示没有这个命令，输入<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>npm link</div></pre></td></tr></table></figure></p><p>刷新命令即可。</p><p>一个最简单的node-cli就完成了。我们来解释下：</p><ul><li>#!/usr/bin/env node在这里有什么作用？<br>首先我们都知道操作系统中都会有一个 PATH 环境变量，当系统调用一个命令的时候，就会在PATH变量中注册的路径中寻找，如果注册的路径中有就调用，否则就提示命令没找到。我们可以通过process.env获取本机系统中所有的环境变量，所以这句话主要是帮助脚本找到node的脚本解释器，可以理解为调用系统中的node来解析我们的脚本。</li></ul><h1 id=处理命令行参数><a href=#处理命令行参数 class=headerlink title=处理命令行参数></a>处理命令行参数</h1><p>node process对象一个提供有关当前Node.js进程的信息和控制的全局对象，在node环境下无需通过require()即可调用。</p><p>process.argv属性返回一个数组，其中包含启动Node.js进程时传递的命令行参数。第一个元素是process.execPath， 如果需要访问argv[0]的原始值，可以使用process.argv0，第二个元素将是要执行的JavaScript文件的路径， 其余元素将是任何其他命令行参数。</p><p>#!/usr/bin/env node<br>console.log(‘call %s’, process.argv[2]);<br>然后输入test hello，打印出call hello。</p><p>对于命令行参数处理，我们用现成的模块commander来处理，commander提供了用户命令行输入和参数解析强大功能。这里我们就使用轻量级，表达力强大的commander进行处理。</p><p>官网：<a href="http://tj.github.io/commander.js/" target=_blank rel=external>commander 官方网站</a></p><p>看一个官网的例子<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div><div class=line>26</div><div class=line>27</div><div class=line>28</div><div class=line>29</div><div class=line>30</div><div class=line>31</div><div class=line>32</div><div class=line>33</div><div class=line>34</div><div class=line>35</div><div class=line>36</div><div class=line>37</div><div class=line>38</div><div class=line>39</div><div class=line>40</div><div class=line>41</div></pre></td><td class=code><pre><div class=line><span class=meta>#!/usr/bin/env node</span></div><div class=line><span class=keyword>var</span> program = <span class=built_in>require</span>(<span class=string>'commander'</span>);</div><div class=line></div><div class=line>program</div><div class=line>  .version(<span class=string>'0.1.0'</span>)</div><div class=line>  .option(<span class=string>'-C, --chdir &lt;path&gt;'</span>, <span class=string>'change the working directory'</span>)</div><div class=line>  .option(<span class=string>'-c, --config &lt;path&gt;'</span>, <span class=string>'set config path. defaults to ./deploy.conf'</span>)</div><div class=line>  .option(<span class=string>'-T, --no-tests'</span>, <span class=string>'ignore test hook'</span>);</div><div class=line></div><div class=line>program</div><div class=line>  .command(<span class=string>'setup [env]'</span>)</div><div class=line>  .description(<span class=string>'run setup commands for all envs'</span>)</div><div class=line>  .option(<span class=string>"-s, --setup_mode [mode]"</span>, <span class=string>"Which setup mode to use"</span>)</div><div class=line>  .action(<span class=function><span class=keyword>function</span>(<span class=params>env, options</span>)</span>&#123;</div><div class=line>    <span class=keyword>var</span> mode = options.setup_mode || <span class=string>"normal"</span>;</div><div class=line>    env = env || <span class=string>'all'</span>;</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'setup for %s env(s) with %s mode'</span>, env, mode);</div><div class=line>  &#125;);</div><div class=line></div><div class=line>program</div><div class=line>  .command(<span class=string>'exec &lt;cmd&gt;'</span>)</div><div class=line>  .alias(<span class=string>'ex'</span>)</div><div class=line>  .description(<span class=string>'execute the given remote cmd'</span>)</div><div class=line>  .option(<span class=string>"-e, --exec_mode &lt;mode&gt;"</span>, <span class=string>"Which exec mode to use"</span>)</div><div class=line>  .action(<span class=function><span class=keyword>function</span>(<span class=params>cmd, options</span>)</span>&#123;</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'exec "%s" using %s mode'</span>, cmd, options.exec_mode);</div><div class=line>  &#125;).on(<span class=string>'--help'</span>, <span class=function><span class=keyword>function</span>(<span class=params></span>) </span>&#123;</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'  Examples:'</span>);</div><div class=line>    <span class=built_in>console</span>.log();</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'    $ deploy exec sequential'</span>);</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'    $ deploy exec async'</span>);</div><div class=line>    <span class=built_in>console</span>.log();</div><div class=line>  &#125;);</div><div class=line></div><div class=line>program</div><div class=line>  .command(<span class=string>'*'</span>)</div><div class=line>  .action(<span class=function><span class=keyword>function</span>(<span class=params>env</span>)</span>&#123;</div><div class=line>    <span class=built_in>console</span>.log(<span class=string>'deploying "%s"'</span>, env);</div><div class=line>  &#125;);</div><div class=line></div><div class=line>program.parse(process.argv);</div></pre></td></tr></table></figure></p><p>首先安装commander<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>yarn add commander <span class=comment># OR npm install commander</span></div></pre></td></tr></table></figure></p><p>看下效果：<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div></pre></td><td class=code><pre><div class=line>hi -V</div><div class=line></div><div class=line>hi setup</div><div class=line></div><div class=line>hi <span class=built_in>exec</span></div></pre></td></tr></table></figure></p><p>#commander.js API</p><ul><li>Option() ——&gt; 初始化自定义参数对象，设置“关键字”和“描述”</li><li>Command() ——&gt; 初始化命令行参数对象，直接获得命令行输入,返回一个数组或者string</li><li>Command#command() ——&gt; 定义命令名称</li><li>Command#arguments() ——&gt; 定义初始命令的参数</li><li>Command#parseExpectedArgs() ——&gt; 解析预期参数</li><li>Command#action() ——&gt; 注册命令的回调函数</li><li>Command#option() ——&gt; 定义参数，需要设置“关键字”和“描述”，关键字包括“简写”和“全写”两部分，以”,”,”|”,”空格”做分隔</li><li>Command#allowUnknownOption() ——&gt; 允许命令行未知参数</li><li>Command#parse() ——&gt; 解析process.argv，设置选项和定义时调用命令</li><li>Command#parseOptions() ——&gt; 解析参数</li><li>Command#opts() ——&gt;设置参数</li><li>Command#description() ——&gt; 添加命令描述</li><li>Command#alias() ——&gt; 设置命令别名</li><li>Command#usage() ——&gt; 设置/获取用法</li><li>Command#name()</li><li>Command#outputHelp() ——&gt; 设置展示的help信息</li><li>Command#help()</li></ul><p>有了上面的API我们来实现一个用于罗列出当前文件夹下所有文件和文件夹的命令list:<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div></pre></td><td class=code><pre><div class=line>program</div><div class=line>	.command( <span class=string>'list'</span> ) <span class=comment>//声明hi下有一个命令叫list</span></div><div class=line>	.description( <span class=string>'list files in current working directory'</span> ) <span class=comment>//给出list这个命令的描述</span></div><div class=line>	.option( <span class=string>'-a, --all'</span>, <span class=string>'Whether to display hidden files'</span> ) <span class=comment>//设置list这个命令的参数</span></div><div class=line>	.action( <span class=function><span class=keyword>function</span> (<span class=params> options </span>) </span>&#123; <span class=comment>//list命令的实现体</span></div><div class=line>		<span class=keyword>var</span> fs = <span class=built_in>require</span>( <span class=string>'fs'</span> );</div><div class=line>		<span class=comment>//获取当前运行目录下的文件信息</span></div><div class=line>		fs.readdir( process.cwd(), <span class=function><span class=keyword>function</span> (<span class=params> err, files </span>) </span>&#123;</div><div class=line>			<span class=keyword>var</span> list = files;</div><div class=line>			<span class=keyword>if</span> ( !options.all ) &#123; <span class=comment>//检查用户是否给了--all或者-a的参数，如果没有，则过滤掉那些以.开头的文件</span></div><div class=line>				list = files.filter( <span class=function><span class=keyword>function</span> (<span class=params> file </span>) </span>&#123;</div><div class=line>					<span class=keyword>return</span> file.indexOf( <span class=string>'.'</span> ) !== <span class=number>0</span>;</div><div class=line>				&#125; );</div><div class=line>			&#125;</div><div class=line>			<span class=built_in>console</span>.log( list.join( <span class=string>'\n\r'</span> ) ); <span class=comment>//控制台将所有文件名打印出来</span></div><div class=line>		&#125; );</div><div class=line>	&#125; );</div></pre></td></tr></table></figure></p><p>运行<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>hi list <span class=comment># hi list -a 或者 --all来查看效果</span></div></pre></td></tr></table></figure></p><p>第一阶段的代码github地址:<a href=https://github.com/CavinHuang/node-cli-demo/tree/0.0.1 target=_blank rel=external>github传送门，0.0.1分支为第一版本的代码</a></p><h1 id=搭建正式版本的开发环境，使它支持es6语法，支持eslint><a href=#搭建正式版本的开发环境，使它支持es6语法，支持eslint class=headerlink title=搭建正式版本的开发环境，使它支持es6语法，支持eslint></a>搭建正式版本的开发环境，使它支持es6语法，支持eslint</h1><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>yarn add -D babel-cli babel-eslint babel-plugin-transform-es2015-modules-commonjs babel-preset-latest-node</div></pre></td></tr></table></figure><p>在项目根目录新建.babelrc，内容为：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div></pre></td><td class=code><pre><div class=line>&#123;</div><div class=line>  <span class=string>"presets"</span>: [</div><div class=line>    [<span class=string>"env"</span>, &#123;</div><div class=line>      <span class=string>"targets"</span>: &#123;</div><div class=line>        <span class=string>"node"</span>: <span class=string>"current"</span></div><div class=line>      &#125;</div><div class=line>    &#125;]</div><div class=line>  ],</div><div class=line>  <span class=string>"plugins"</span>: [</div><div class=line>    <span class=string>"transform-es2015-modules-commonjs"</span></div><div class=line>  ]</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>新建src目录，用于开发，新建src/command目录和src/utils目录，用于开发使用。<br>建好后目录结构如下：<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div></pre></td><td class=code><pre><div class=line>├─bin             <span class=comment># 脚本启动文件所在目录</span></div><div class=line>├─node_modules    <span class=comment># libraray 目录</span></div><div class=line>│  └─commander    </div><div class=line>│      └─typings  </div><div class=line>└─src             <span class=comment># 开发目录</span></div><div class=line>    ├─<span class=built_in>command</span>     <span class=comment># 命令实现目录，一个命令对应一个文件</span></div><div class=line>    └─utils       <span class=comment># 工具目录</span></div></pre></td></tr></table></figure></p><p>接下来我们实现一个入口，把功能转到对应的命令实现文件，来具体实现。新建index.js用于处理入口，再建立src/index.js用于实际的功能转发<br>index.js 内容如下<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div></pre></td><td class=code><pre><div class=line><span class=comment>// babel解析</span></div><div class=line><span class=built_in>require</span>( <span class=string>"babel-register"</span> )</div><div class=line><span class=built_in>require</span>( <span class=string>"babel-core"</span> )</div><div class=line>	.transform( <span class=string>"code"</span>, &#123;</div><div class=line>		presets: [ [ <span class=built_in>require</span>( <span class=string>'babel-preset-latest-node'</span> ), &#123;</div><div class=line>			target: <span class=string>'current'</span></div><div class=line>		&#125; ] ]</div><div class=line>	&#125; );</div><div class=line><span class=built_in>require</span>( <span class=string>'babel-polyfill'</span> )</div><div class=line></div><div class=line><span class=built_in>require</span>(<span class=string>'./src'</span>)</div></pre></td></tr></table></figure></p><p>src/index.js 内容如下：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div></pre></td><td class=code><pre><div class=line><span class=keyword>var</span> program = <span class=built_in>require</span>( <span class=string>'commander'</span> );</div><div class=line>program.parse( process.argv ); <span class=comment>//开始解析用户输入的命令</span></div><div class=line><span class=built_in>require</span>( <span class=string>'./command/'</span> + program.args + <span class=string>'.js'</span> ) <span class=comment>// 根据不同的命令转到不同的命令处理文件</span></div></pre></td></tr></table></figure></p><p>解释一下，为什么我想这样做：</p><ul><li>为了保证文件单一职责，方便维护；</li><li>方便dev和product加载。<br>接下来我们建立相应的问价即可，src/command/init.js src/command/install.js 两个命令处理文件，内容如下：</li></ul><p>src/command/list.js:<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div></pre></td><td class=code><pre><div class=line><span class=keyword>var</span> program = <span class=built_in>require</span>( <span class=string>'commander'</span> );</div><div class=line>program</div><div class=line>	.command( <span class=string>'init'</span> )</div><div class=line>	.description( <span class=string>'init project for local'</span> )</div><div class=line>	.action( <span class=function><span class=keyword>function</span> (<span class=params> options </span>) </span>&#123; <span class=comment>//list命令的实现体</span></div><div class=line>		<span class=comment>// to do</span></div><div class=line>		<span class=built_in>console</span>.log( <span class=string>'init command'</span> );</div><div class=line>	&#125; );</div><div class=line>program.parse( process.argv ); <span class=comment>//开始解析用户输入的命令</span></div></pre></td></tr></table></figure></p><p>src/command/install.js:<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div></pre></td><td class=code><pre><div class=line><span class=keyword>var</span> program = <span class=built_in>require</span>( <span class=string>'commander'</span> );</div><div class=line>program</div><div class=line>	.command( <span class=string>'install'</span> )</div><div class=line>	.description( <span class=string>'install github project to local'</span> )</div><div class=line>	.action( <span class=function><span class=keyword>function</span> (<span class=params> options </span>) </span>&#123; <span class=comment>//list命令的实现体</span></div><div class=line>		<span class=comment>// to do</span></div><div class=line>		<span class=built_in>console</span>.log( <span class=string>'install command'</span> );</div><div class=line>	&#125; );</div><div class=line>program.parse( process.argv ); <span class=comment>//开始解析用户输入的命令</span></div></pre></td></tr></table></figure></p><p>在命令行输入以下命令来测试:<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div></pre></td><td class=code><pre><div class=line>webpack-template install</div><div class=line></div><div class=line>webpack-template init</div></pre></td></tr></table></figure></p><p>第二版完成代码地址：<a href=https://github.com/CavinHuang/node-cli-demo/tree/0.0.2 target=_blank rel=external>【第二版github地址，可以clone下来试试】</a></p><p>接下来我们分别实现install功能和init功能。<br>首先，install步骤设想如下：</p><ul><li>通过github api拉取仓库里的模板项目</li><li>通过选择模板进行下载</li><li>缓存至本地临时目录，供下次直接使用</li></ul><p>首先，去<a href="https://developer.github.com/v3/repos/" target=_blank rel=external>github api v3</a>找到所需的api接口，<br>为了方便单独管理模板项目，我新建了一个organization来管理。所以，我主要是通过<br><figure class="highlight elixir"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div></pre></td><td class=code><pre><div class=line>/orgs/<span class=symbol>:org/repos</span> <span class=comment>#获取项目</span></div><div class=line>和</div><div class=line>/repos/<span class=symbol>:owner/</span><span class=symbol>:repo</span> <span class=comment>#获取版本</span></div></pre></td></tr></table></figure></p><p>项目已经建好，可以通过以下api来查看仓库详情<br>1、项目列表<br><figure class="highlight stylus"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>url -<span class=selector-tag>i</span> https:<span class=comment>//api.github.com/orgs/cavinHuangORG/repos</span></div></pre></td></tr></table></figure></p><p>2、项目版本<br><figure class="highlight awk"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>curl -i https:<span class=regexp>//</span>api.github.com<span class=regexp>/repos/</span>cavinHuangORG<span class=regexp>/webpack-multipage-template/</span>tags</div></pre></td></tr></table></figure></p><p>通过命令行选择选项，效果如下：<br><img src=/一步一步完成一个node-cli/inquirer.gif></p><p>这里我们用到另外一个命令行交互的库，inquirer.js,主要用来命令行选择和输入；<br>我们先实现一个简单的在insatll.js完成如下代码：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div></pre></td><td class=code><pre><div class=line><span class=keyword>var</span> inquirer = <span class=built_in>require</span>( <span class=string>'inquirer'</span> );</div><div class=line>program</div><div class=line>	.command( <span class=string>'install'</span> )</div><div class=line>	.description( <span class=string>'install github project to local'</span> )</div><div class=line>	.action( <span class=function><span class=keyword>function</span> (<span class=params> options </span>) </span>&#123; <span class=comment>//list命令的实现体</span></div><div class=line>		<span class=comment>// to do</span></div><div class=line>		<span class=built_in>console</span>.log( <span class=string>'install command'</span> );</div><div class=line>		<span class=keyword>let</span> choices = [ <span class=string>'aaa'</span>, <span class=string>'bbb'</span>, <span class=string>'ccc'</span>, <span class=string>'dddd'</span> ];</div><div class=line>		<span class=keyword>let</span> questions = [ &#123;</div><div class=line>			type: <span class=string>'list'</span>,</div><div class=line>			name: <span class=string>'repo'</span>,</div><div class=line>			message: <span class=string>'which repo do you want to install?'</span>,</div><div class=line>			choices</div><div class=line>  &#125; ];</div><div class=line>		<span class=comment>// 调用问题</span></div><div class=line>		inquirer.prompt( questions )</div><div class=line>			.then( <span class=function><span class=params>answers</span> =&gt;</span> &#123;</div><div class=line>				<span class=built_in>console</span>.log( answers ); <span class=comment>// 输出最终的答案</span></div><div class=line>			&#125; )</div><div class=line>	&#125; );</div><div class=line>program.parse( process.argv ); <span class=comment>//开始解析用户输入的命令</span></div></pre></td></tr></table></figure></p><p>最终结果如下：<br><img src=/一步一步完成一个node-cli/install-1.gif title=选择效果><br>到此已经我们要的效果已经差不多完成了。下一步，我希望可以通过用户输入一些特定的参数，来初始化整个项目。</p><h1 id=download-git-repo><a href=#download-git-repo class=headerlink title=download-git-repo></a>download-git-repo</h1><p>下面我们要用到一个库，来下载github库的代码，<a href=https://github.com/flipxfx/download-git-repo target=_blank rel=external>download-git-repo</a>,用法如下：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>download(repository, destination, options, callback)</div></pre></td></tr></table></figure></p><blockquote><p>Download a git repository to a destination folder with options, and callback.<br>将Git存储库下载到带有选项的目标文件夹和回调函数</p></blockquote><ul><li><p>repository github库地址</p><ul><li>GitHub - github:owner/name 或者简写为 owner/name</li><li>GitLab - gitlab:owner/name</li><li>Bitbucket - bitbucket:owner/name</li></ul></li><li><p>destination 目标文件夹</p></li><li>options 下载时携带的参数<ul><li>clone 默认false</li></ul></li><li>callback 完成之后的回调</li></ul><h2 id=download-git-repo-用法实例><a href=#download-git-repo-用法实例 class=headerlink title="download-git-repo 用法实例"></a>download-git-repo 用法实例</h2><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div></pre></td><td class=code><pre><div class=line><span class=keyword>const</span> downloadGitRepo = <span class=built_in>require</span>(<span class=string>'download-git repo'</span>)</div><div class=line><span class=comment>// 把目标项目下载到当前目录下的test下</span></div><div class=line>downloadGitRepo(<span class=string>'CavinHuang/node-cli-demo'</span>, <span class=string>'./test'</span>, <span class=literal>false</span>, err =&gt; &#123;</div><div class=line>  <span class=built_in>console</span>.log(err ? <span class=string>'SUCCESS'</span> : <span class=string>"FAIL"</span>);</div><div class=line>&#125; )</div></pre></td></tr></table></figure><h1 id=完成git操作类><a href=#完成git操作类 class=headerlink title=完成git操作类></a>完成git操作类</h1><p>我们专门分装一个类用来获取git仓库列表、版本信息、下载git代码等操作，主要有以下几个方法，代码就不贴了，代码全在git仓库0.0.3分支<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div></pre></td><td class=code><pre><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 获取git仓库列表</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>async</span> fetchRepoList() &#123;&#125;</div><div class=line></div><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 获取仓库所有的版本</span></div><div class=line><span class=comment> * @param  &#123;[string]&#125; repo [仓库名称]</span></div><div class=line><span class=comment> * @return &#123;[type]&#125;      [description]</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>async</span> fetchRepoTagList( repo ) &#123;&#125;</div><div class=line></div><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 获取仓库详细信息</span></div><div class=line><span class=comment> * @param  &#123;[string]&#125; repo [仓库名称]</span></div><div class=line><span class=comment> * @return &#123;[type]&#125;      [description]</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>async</span> fetchGitInfo( repo ) &#123;&#125;</div><div class=line></div><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 下载git仓库代码到指定文件夹</span></div><div class=line><span class=comment> * @param  &#123;[string]&#125; repo [仓库名称]</span></div><div class=line><span class=comment> * @return &#123;[type]&#125;      [description]</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>async</span> downloadGitRepo( repo ) &#123;&#125;</div></pre></td></tr></table></figure></p><p>在install.js里，首先我们要把仓库里的所有的模板拉出来供选择,只要把choices换成我们通过api获取的git长裤列表即可<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div></pre></td><td class=code><pre><div class=line><span class=keyword>import</span> gitCtrl <span class=keyword>from</span> <span class=string>'../utils/gitCtrl'</span></div><div class=line><span class=keyword>import</span> config <span class=keyword>from</span> <span class=string>'../config'</span></div><div class=line><span class=comment>// 初始化git操作类</span></div><div class=line><span class=keyword>let</span> git = <span class=keyword>new</span> gitCtrl.gitCtrl( config.repoType, config.registry )</div></pre></td></tr></table></figure></p><p>action里的改成：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div></pre></td><td class=code><pre><div class=line><span class=comment>// 获取git仓库列表</span></div><div class=line><span class=keyword>let</span> choices = <span class=keyword>await</span> git.fetchRepoList();</div></pre></td></tr></table></figure></p><p>下面是根据用户选择仓库下载代码到本地, 我们新建一个config文件夹用来存放一些配置，定义一些常用的变量，如缓存目录，版本等等，新建constant.js<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div><div class=line>26</div><div class=line>27</div><div class=line>28</div><div class=line>29</div><div class=line>30</div><div class=line>31</div><div class=line>32</div><div class=line>33</div><div class=line>34</div></pre></td><td class=code><pre><div class=line><span class=keyword>const</span> os = <span class=built_in>require</span>( <span class=string>'os'</span> );</div><div class=line><span class=keyword>import</span> &#123;</div><div class=line>	name,</div><div class=line>	version,</div><div class=line>	engines</div><div class=line>&#125; <span class=keyword>from</span> <span class=string>'../../package.json'</span>;</div><div class=line></div><div class=line><span class=comment>// 系统user文件夹</span></div><div class=line><span class=keyword>const</span> home = process.env[ ( process.platform === <span class=string>'win32'</span> ) ? <span class=string>'USERPROFILE'</span> : <span class=string>'HOME'</span> ];</div><div class=line></div><div class=line><span class=comment>// user agent</span></div><div class=line><span class=keyword>export</span> <span class=keyword>const</span> ua = <span class=string>`<span class=subst>$&#123;name&#125;</span>-<span class=subst>$&#123;version&#125;</span>`</span>;</div><div class=line></div><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 文件夹定义</span></div><div class=line><span class=comment> * @type &#123;Object&#125;</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>export</span> <span class=keyword>const</span> dirs = &#123;</div><div class=line>	home,</div><div class=line>	download: <span class=string>`<span class=subst>$&#123;home&#125;</span>/.webpack-project`</span>,</div><div class=line>	rc: <span class=string>`<span class=subst>$&#123;home&#125;</span>/.webpack-project`</span>,</div><div class=line>	tmp: os.tmpdir(),</div><div class=line>	metalsmith: <span class=string>'metalsmith'</span></div><div class=line>&#125;;</div><div class=line></div><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 版本</span></div><div class=line><span class=comment> * @type &#123;Object&#125;</span></div><div class=line><span class=comment> */</span></div><div class=line><span class=keyword>export</span> <span class=keyword>const</span> versions = &#123;</div><div class=line>	node: process.version.substr( <span class=number>1</span> ),</div><div class=line>	nodeEngines: engines.node,</div><div class=line>  [ name ]: version</div><div class=line>&#125;;</div></pre></td></tr></table></figure></p><p>index.js<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div></pre></td><td class=code><pre><div class=line><span class=comment>/**</span></div><div class=line><span class=comment> * 配置文件</span></div><div class=line><span class=comment> */</span></div><div class=line></div><div class=line><span class=keyword>export</span> <span class=keyword>default</span> &#123;</div><div class=line>	registry: <span class=string>'cavinHuangORG'</span>, <span class=comment>// 仓库地址</span></div><div class=line>	repoType: <span class=string>'org'</span>, <span class=comment>// ['org', 'user']</span></div><div class=line>	metalsmith: <span class=literal>true</span></div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>有了这些，下边我们就下载代码了:<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div></pre></td><td class=code><pre><div class=line><span class=comment>// 下载库</span></div><div class=line><span class=keyword>let</span> result = <span class=keyword>await</span> git.downloadGitRepo( answers.repo )</div><div class=line><span class=built_in>console</span>.log( result ? <span class=string>'SUCCESS'</span> : result )</div></pre></td></tr></table></figure></p><p>这时我们运行<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>webpack-template install</div></pre></td></tr></table></figure></p><p>结果如下：<br><img src=/一步一步完成一个node-cli/install-2.gif title=install结果><br>下面我们添加版本选择,我们把install.js里的代码，稍微修改下,加上版本选择：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div></pre></td><td class=code><pre><div class=line><span class=comment>// 取出选择的git仓库</span></div><div class=line><span class=keyword>const</span> repo = answers.repo;</div><div class=line><span class=comment>// 获取选择仓库所有的版本</span></div><div class=line><span class=keyword>const</span> tags = <span class=keyword>await</span> git.fetchRepoTagList( repo );</div><div class=line></div><div class=line><span class=keyword>if</span> ( tags.length === <span class=number>0</span> ) &#123;</div><div class=line>  version = <span class=string>''</span>;</div><div class=line>&#125; <span class=keyword>else</span> &#123;</div><div class=line>  choices = tags.map( ( &#123;</div><div class=line>    name</div><div class=line>  &#125; ) =&gt; name );</div><div class=line></div><div class=line>  answers = <span class=keyword>await</span> inquirer.prompt( [</div><div class=line>    &#123;</div><div class=line>      type: <span class=string>'list'</span>,</div><div class=line>      name: <span class=string>'version'</span>,</div><div class=line>      message: <span class=string>'which version do you want to install?'</span>,</div><div class=line>      choices</div><div class=line>  &#125;</div><div class=line>] );</div><div class=line>  version = answers.version;</div><div class=line>&#125;</div><div class=line><span class=built_in>console</span>.log( answers ); <span class=comment>// 输出最终的答案</span></div><div class=line><span class=keyword>let</span> result = <span class=keyword>await</span> git.downloadGitRepo( [ repo, version ].join( <span class=string>'@'</span> ) );</div><div class=line><span class=built_in>console</span>.log( result ? <span class=string>'SUCCESS'</span> : result )</div></pre></td></tr></table></figure></p><img src=/一步一步完成一个node-cli/install-3.gif title=install结果><p>这时我们去看系统的user文件夹下的.webpack-project下，就会找到我们换成的项目了。<br>到这里，我们install代码已经完成了，<a href=https://github.com/CavinHuang/node-cli-demo/tree/v0.0.3 target=_blank rel=external>github地址</a></p><h1 id=完成init命令><a href=#完成init命令 class=headerlink title=完成init命令></a>完成init命令</h1><p>init命令是通过收录一些用户填写的信息来初始化本地项目，其实原理就是把收录的参数进行替换，把下载到缓存目录的项目copy到当前命令行执行目录。<br>首先我们还是完成最简单的命令行用户输入信息的收入，此处依然使用inquirer来完成：<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div><div class=line>26</div><div class=line>27</div><div class=line>28</div></pre></td><td class=code><pre><div class=line><span class=comment>// 1、选择哪个模板</span></div><div class=line><span class=comment>// 2、当前项目的名字，也是初始化项目的文件夹名字</span></div><div class=line><span class=keyword>let</span> questions = [</div><div class=line>  &#123;</div><div class=line>    type: <span class=string>'list'</span>,</div><div class=line>    name: <span class=string>'template'</span>,</div><div class=line>    message: <span class=string>'which template do you want to init?'</span>,</div><div class=line>    choices: list</div><div class=line>  &#125;, &#123;</div><div class=line>    type: <span class=string>'input'</span>,</div><div class=line>    name: <span class=string>'dir'</span>,</div><div class=line>    message: <span class=string>'project name'</span>,</div><div class=line>    <span class=keyword>async</span> validate( input ) &#123;</div><div class=line>      <span class=comment>// 下面这行代码用于通知异步任务</span></div><div class=line>      <span class=keyword>const</span> done = <span class=keyword>this</span>.async();</div><div class=line>      <span class=keyword>if</span> ( input.length === <span class=number>0</span> ) &#123;</div><div class=line>        done( <span class=string>'You must input project name'</span> );</div><div class=line>        <span class=keyword>return</span>;</div><div class=line>      &#125;</div><div class=line>      <span class=keyword>const</span> dir = resolve( process.cwd(), input );</div><div class=line>      <span class=keyword>if</span> ( <span class=keyword>await</span> exists( dir ) ) &#123;</div><div class=line>        done( <span class=string>'The project name is already existed. Please change another name'</span> );</div><div class=line>      &#125;</div><div class=line>      done( <span class=literal>null</span>, <span class=literal>true</span> );</div><div class=line>    &#125;</div><div class=line>  &#125;</div><div class=line>];</div><div class=line><span class=keyword>const</span> answers = <span class=keyword>await</span> inquirer.prompt( questions )</div></pre></td></tr></table></figure></p><h2 id=ncp使用帮助><a href=#ncp使用帮助 class=headerlink title=ncp使用帮助></a>ncp使用帮助</h2><p>下面是准备收集更加详细的信息，并且把下载的文件copy一份到临时目录，用于处理，此处copy文件用的是成熟的ncp库，这是一个与linux cp命令接口一致的库。<a href=https://github.com/AvianFlu/ncp target=_blank rel=external>官方网站</a>,基本调用方式:<figure class="highlight plain"><figcaption><span>[source] [dest] [--limit</span></figcaption><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div></pre></td><td class=code><pre><div class=line>实例代码:</div><div class=line>```js</div><div class=line>var ncp = require(&apos;ncp&apos;).ncp;</div><div class=line></div><div class=line>ncp.limit = 16;</div><div class=line></div><div class=line>ncp(source, destination, function (err) &#123;</div><div class=line> if (err) &#123;</div><div class=line>   return console.error(err);</div><div class=line> &#125;</div><div class=line> console.log(&apos;done!&apos;);</div><div class=line>&#125;);</div></pre></td></tr></table></figure></p><h2 id=mkdirp使用帮助><a href=#mkdirp使用帮助 class=headerlink title=mkdirp使用帮助></a>mkdirp使用帮助</h2><p>主要作用跟linux mkdir -p 是一样的，只是它运行在node里，也就是递归创建目录。<br>主要用法:<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div></pre></td><td class=code><pre><div class=line><span class=keyword>var</span> mkdirp = <span class=built_in>require</span>(<span class=string>'mkdirp'</span>);</div><div class=line></div><div class=line>mkdirp(<span class=string>'/tmp/foo/bar/baz'</span>, <span class=function><span class=keyword>function</span> (<span class=params>err</span>) </span>&#123;</div><div class=line>    <span class=keyword>if</span> (err) <span class=built_in>console</span>.error(err)</div><div class=line>    <span class=keyword>else</span> <span class=built_in>console</span>.log(<span class=string>'pow!'</span>)</div><div class=line>&#125;);</div></pre></td></tr></table></figure></p><p>根据这两个库，我们分装一个专门用来copy我们项目的工具函数<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div></pre></td><td class=code><pre><div class=line><span class=keyword>import</span> &#123;</div><div class=line>	ncp</div><div class=line>&#125; <span class=keyword>from</span> <span class=string>'ncp'</span>;</div><div class=line><span class=keyword>import</span> mkdirp <span class=keyword>from</span> <span class=string>'mkdirp'</span></div><div class=line><span class=keyword>import</span> &#123;</div><div class=line>	exists</div><div class=line>&#125; <span class=keyword>from</span> <span class=string>'mz/fs'</span></div><div class=line><span class=keyword>export</span> <span class=keyword>default</span> <span class=function><span class=keyword>function</span> <span class=title>copyFile</span>(<span class=params> src, dest </span>) </span>&#123;</div><div class=line>	<span class=keyword>return</span> <span class=keyword>new</span> <span class=built_in>Promise</span>( <span class=keyword>async</span> ( resolve, reject ) =&gt; &#123;</div><div class=line>		<span class=keyword>if</span> ( !( <span class=keyword>await</span> exists( src ) ) ) &#123;</div><div class=line>			mkdirp.sync( src ); <span class=comment>//异步创建</span></div><div class=line>		&#125;</div><div class=line>		ncp( src, dest, ( err ) =&gt; &#123;</div><div class=line>			<span class=keyword>if</span> ( err ) &#123;</div><div class=line>				reject( err );</div><div class=line>				<span class=keyword>return</span>;</div><div class=line>			&#125;</div><div class=line>			resolve();</div><div class=line>		&#125; );</div><div class=line>	&#125; );</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>copy到临时文件夹，生成项目是，要经过一个数据填充的过程，这个过程主要用的是一个静态站点生成器（<a href=https://www.npmjs.com/package/metalsmith target=_blank rel=external>Metalsmith</a>）和swig以及<a href=https://github.com/visionmedia/consolidate.js target=_blank rel=external>consolidate一个模板引擎合并库</a></p><p>在init.js里添加copy的动作和编译的动作<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div></pre></td><td class=code><pre><div class=line><span class=keyword>const</span> answers = <span class=keyword>await</span> inquirer.prompt( questions )</div><div class=line><span class=keyword>const</span> metalsmith = config.metalsmith;</div><div class=line><span class=keyword>if</span> ( metalsmith ) &#123;</div><div class=line>  <span class=keyword>const</span> tmp = <span class=string>`<span class=subst>$&#123;dirs.tmp&#125;</span>/<span class=subst>$&#123;answers.template&#125;</span>`</span>;</div><div class=line>  <span class=comment>// 复制一份到临时目录，在临时目录编译生成</span></div><div class=line>  <span class=keyword>await</span> copyFile( <span class=string>`<span class=subst>$&#123;dirs.download&#125;</span>/<span class=subst>$&#123;answers.template&#125;</span>`</span>, tmp );</div><div class=line>  <span class=keyword>await</span> metalsmithACtion( answers.template ); <span class=comment>// 根据参数编译</span></div><div class=line>  <span class=keyword>await</span> copyFile( <span class=string>`<span class=subst>$&#123;tmp&#125;</span>/<span class=subst>$&#123;dirs.metalsmith&#125;</span>`</span>, answers.dir );</div><div class=line>  <span class=keyword>await</span> rmfr( tmp ); <span class=comment>// 清除临时文件夹</span></div><div class=line>&#125; <span class=keyword>else</span> &#123;</div><div class=line>  <span class=keyword>await</span> copyFile( <span class=string>`<span class=subst>$&#123;dirs.download&#125;</span>/<span class=subst>$&#123;answers.template&#125;</span>`</span>, answers.dir );</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>最后所有的目录结构如下：<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div><div class=line>7</div><div class=line>8</div><div class=line>9</div><div class=line>10</div><div class=line>11</div><div class=line>12</div><div class=line>13</div><div class=line>14</div><div class=line>15</div><div class=line>16</div><div class=line>17</div><div class=line>18</div><div class=line>19</div><div class=line>20</div><div class=line>21</div><div class=line>22</div><div class=line>23</div><div class=line>24</div><div class=line>25</div></pre></td><td class=code><pre><div class=line>│  .babelrc</div><div class=line>│  .gitignore</div><div class=line>│  index.js</div><div class=line>│  package.json</div><div class=line>│  </div><div class=line>├─bin</div><div class=line>│      hi.js</div><div class=line>│                      </div><div class=line>└─src</div><div class=line>    │  index.js</div><div class=line>    │  </div><div class=line>    ├─<span class=built_in>command</span></div><div class=line>    │      init.js</div><div class=line>    │      install.js</div><div class=line>    │      </div><div class=line>    ├─config</div><div class=line>    │      constant.js</div><div class=line>    │      index.js</div><div class=line>    │      </div><div class=line>    └─utils</div><div class=line>            copyFile.js</div><div class=line>            gitCtrl.js</div><div class=line>            initProjectQuestion.js    <span class=comment>#初始化项目的问题</span></div><div class=line>            metalsmithACtion.js       <span class=comment>#临时文件夹编译动作</span></div><div class=line>            render.js                 <span class=comment>#编译模板的插件</span></div></pre></td></tr></table></figure></p><p>到此所有的功能就已经实现了，为了让整个命令用起来更加人性化，更加流程，我们引入ora这个库，项目地址:<a href=https://github.com/sindresorhus/ora target=_blank rel=external>ora</a>,主要效果如下：<br><img src=/一步一步完成一个node-cli/init.svg></p><p>在utils里新建OraLoading.js<br><figure class="highlight js"><table><tr><td class=gutter><pre><div class=line>1</div><div class=line>2</div><div class=line>3</div><div class=line>4</div><div class=line>5</div><div class=line>6</div></pre></td><td class=code><pre><div class=line><span class=keyword>import</span> ora <span class=keyword>from</span> <span class=string>'ora'</span>;</div><div class=line></div><div class=line><span class=keyword>export</span> <span class=keyword>default</span> <span class=function><span class=keyword>function</span> <span class=title>OraLoading</span>(<span class=params> action = <span class=string>'getting'</span>, repo = <span class=string>''</span> </span>) </span>&#123;</div><div class=line>	<span class=keyword>const</span> l = ora( <span class=string>`<span class=subst>$&#123;action&#125;</span> <span class=subst>$&#123;repo&#125;</span>`</span> );</div><div class=line>	<span class=keyword>return</span> l.start();</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>好了，到了这里所有的东西都已经写完了，下面我们来试试效果：<br>首先是install<br><img src=/一步一步完成一个node-cli/install-last.gif><br>init也是一样的就不演示了</p><h1 id=npm-发布><a href=#npm-发布 class=headerlink title="npm 发布"></a>npm 发布</h1><ul><li>到npm.com注册好自己的账户，命令行然后切换到当前目录的文件夹,执行npm login命令，输入自己的账号密码，进行登录即可。</li></ul><p>执行<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>npm publish .</div></pre></td></tr></table></figure></p><p>就可以发布自己的npm包了，注意此处一个坑，如果你是用的淘宝源，需要切换回npm源，<br><figure class="highlight bash"><table><tr><td class=gutter><pre><div class=line>1</div></pre></td><td class=code><pre><div class=line>npm config <span class=built_in>set</span> registry http://registry.npmjs.org</div></pre></td></tr></table></figure></p><p>否则验证不通过。</p><p>最后奉上github完成代码地址: <a href=https://github.com/CavinHuang/node-cli-demo target=_blank rel=external>github传送门</a></p><p>请各位老铁不要吝啬自己的start，感谢鼓励！</p></div><div id=side-right-bar><div class=close-right-bar></div><div class=sidebar-toc><div class=sidebar-toc__title>目录</div><div class=sidebar-toc__progress><span class=progress-notice>你已经阅读了</span><span class=progress-num>0</span><span class=progress-percentage>%</span><div class=sidebar-toc__progress-bar></div></div><div class=sidebar-toc__content><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#实现第一个自己的node命令><span class=toc-number>1.</span> <span class=toc-text>实现第一个自己的node命令</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#处理命令行参数><span class=toc-number>2.</span> <span class=toc-text>处理命令行参数</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#搭建正式版本的开发环境，使它支持es6语法，支持eslint><span class=toc-number>3.</span> <span class=toc-text>搭建正式版本的开发环境，使它支持es6语法，支持eslint</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#download-git-repo><span class=toc-number>4.</span> <span class=toc-text>download-git-repo</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#download-git-repo-用法实例><span class=toc-number>4.1.</span> <span class=toc-text>download-git-repo 用法实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#完成git操作类><span class=toc-number>5.</span> <span class=toc-text>完成git操作类</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#完成init命令><span class=toc-number>6.</span> <span class=toc-text>完成init命令</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#ncp使用帮助><span class=toc-number>6.1.</span> <span class=toc-text>ncp使用帮助</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#mkdirp使用帮助><span class=toc-number>6.2.</span> <span class=toc-text>mkdirp使用帮助</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#npm-发布><span class=toc-number>7.</span> <span class=toc-text>npm 发布</span></a></li></ol></div></div></div><div class=right-btn id=right-btn><span>目录</span></div><div class=article-bottom><div class="addthis_inline_share_toolbox fr"></div></div><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta>文章作者:</span><span class=post-copyright-info><a href=mailto:undefined>CavinHuang</a></span></div><div class=post-copyright__type><span class=post-copyright-meta>文章链接:</span><span class=post-copyright-info><a href="http://blog.zukmb.cn一步一步完成一个node-cli/">http://blog.zukmb.cn一步一步完成一个node-cli/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta>版权声明:</span><span class=post-copyright-info>转载请注明来自<a href=http://blog.zukmb.cn target=_blank style="font-size: 18px;">CavinHuangのBlog</a>！</span></div></div><div class=article-pagenate><div class="article-prev fl"><span>←</span><a href="/给vue配置axios包括报错-鉴权-跳转-拦截-提示的封装/">给vue配置axios包括报错,鉴权,跳转,拦截,提示的封装</a></div><div class="article-next fr"><a href="/webpack多页面配置记录/">webpack多页面配置记录</a><span>→</span></div></div></article></div><footer class=footer><div id=toTop style="display: none;">Back to Top</div></footer></div></div><canvas class=fireworks></canvas><script src=/js/velocity.ui.min.js></script><script src=/js/yoyo.js></script><script src=/js/scroll.js></script><script src=/js/particle.js></script><script src=/js/anime.min.js></script><script src=/js/fireworks.js></script>